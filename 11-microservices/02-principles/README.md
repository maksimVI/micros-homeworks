
# Домашнее задание к занятию «Микросервисы: принципы»

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

## Задача 1: API Gateway 

Предложите решение для обеспечения реализации API Gateway. Составьте сравнительную таблицу возможностей различных программных решений. На основе таблицы сделайте выбор решения.

Решение должно соответствовать следующим требованиям:
- маршрутизация запросов к нужному сервису на основе конфигурации,
- возможность проверки аутентификационной информации в запросах,
- обеспечение терминации HTTPS.

Обоснуйте свой выбор.

## Ответ 1

### Сравнительная таблица возможностей:

| Возможность                 | NGINX                       | Kong                          | Traefik                        | Yandex API Gateway            | AWS API Gateway                |
| --------------------------- | --------------------------- | ----------------------------- | ------------------------------ | ----------------------------- | ------------------------------ |
| Маршрутизация запросов      | Да                          | Да                            | Да                             | Да                            | Да                             |
| Проверка аутентификации     | Частично (через модули)     | Да                            | Да (через middleware)          | Да                            | Да                             |
| Терминация HTTPS            | Да                          | Да                            | Да                             | Да                            | Да                             |
| Лёгкость интеграции         | Высокая                     | Средняя                       | Высокая                        | Высокая (в экосистеме Yandex) | Высокая (в AWS экосистеме)     |
| Расширяемость               | Средняя (модули/настройки)  | Высокая (плагины)             | Высокая (плагины и middleware) | Высокая                       | Высокая через Lambda           |
| Стоимость                   | Низкая (open-source)        | Может варьироваться           | Низкая (open-source)           | Конкурентоспособная           | Высокая на больших объёмах     |
| Поддержка и сообщество      | Большое сообщество          | Обширное сообщество           | Активное сообщество            | Поддержка от Яндекса          | Поддержка от AWS               |
| Оперативность развертывания | Средняя (требует настройки) | Средняя (настройка и плагины) | Высокая                        | Высокая                       | Высокая                        |
| Мониторинг и логирование    | Среднее                     | Хорошее (встроенные средства) | Хорошее (интеграции)           | Хорошее (встроенные средства) | Отличное (встроенные средства) |
| Модель развертывания        | Локально либо в облаке      | Локально либо в облаке        | Локально либо в облаке         | В облаке                      | В облаке                       |

Перечисленные выше требования можно реализовать с помощью NGINX на базовом уровне. Скорее всего будет достаточно минимальной команды, 1-2 человека, например, ведущий инженер и разработчик. Возможно команде будет нужна небольшая консультация специалиста или временно привлечь стороннюю поддержку для первоначальной настройки, если небыло предыдущего опыта или времени на обучение. NGINX имеет хорошую документацию и сообщество, многие из перечисленных требований можно освоить самостоятельно.

## Задача 2: Брокер сообщений

Составьте таблицу возможностей различных брокеров сообщений. На основе таблицы сделайте обоснованный выбор решения.

Решение должно соответствовать следующим требованиям:
- поддержка кластеризации для обеспечения надёжности,
- хранение сообщений на диске в процессе доставки,
- высокая скорость работы,
- поддержка различных форматов сообщений,
- разделение прав доступа к различным потокам сообщений,
- простота эксплуатации.

Обоснуйте свой выбор.

## Ответ 2

### Сравнительная таблица возможностей:

| Функциональность             | Apache Kafka                                                        | RabbitMQ                                | ActiveMQ                     | Yandex Message Queue                            |
| ---------------------------- | ------------------------------------------------------------------- | --------------------------------------- | ---------------------------- | ----------------------------------------------- |
| Кластеризация                | Да                                                                  | Да                                      | Да                           | Да                                              |
| Хранение на диске            | Да, поддержка долговременного хранения                              | Да, с возможностью длительного хранения | Да                           | Нет (обеспечивающей надежность другим способом) |
| Скорость работы              | Очень высокая (оптимизирован для работы с большими объемами данных) | Высокая                                 | Средняя                      | Высокая (оптимизирована для облачных нагрузок)  |
| Поддержка форматов сообщений | Любые форматы (JSON, Avro, Protobuf, др.)                           | Любые форматы, поддержка Plug-in        | Текст, двоичные данные (JMS) | Любые форматы                                   |
| Разделение прав доступа      | Да, через Apache Kafka ACLs                                         | Да, поддержка через плагины             | Да, поддержка через брокеры  | Да, через IAM Yandex                            |
| Простота эксплуатации        | Средняя, требует настройки и мониторинга                            | Более простая установка и конфигурация  | Средняя, требует настройки   | Высокая, полностью управляемое облачное решение |

Yandex Message Queue можно было не добавлять в таблицу, добавил как одно из облачных решений. Больше подойдёт RabbitMQ, т.к. самый популярный брокер, прост в установке и более гибкий благодаря поддержке множества плагинов.

## Задача 3: API Gateway * (необязательная)

### Есть три сервиса:

**minio**
- хранит загруженные файлы в бакете images,
- S3 протокол,

**uploader**
- принимает файл, если картинка сжимает и загружает его в minio,
- POST /v1/upload,

**security**
- регистрация пользователя POST /v1/user,
- получение информации о пользователе GET /v1/user,
- логин пользователя POST /v1/token,
- проверка токена GET /v1/token/validation.

### Необходимо воспользоваться любым балансировщиком и сделать API Gateway:

**POST /v1/register**
1. Анонимный доступ.
2. Запрос направляется в сервис security POST /v1/user.

**POST /v1/token**
1. Анонимный доступ.
2. Запрос направляется в сервис security POST /v1/token.

**GET /v1/user**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис security GET /v1/user.

**POST /v1/upload**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис uploader POST /v1/upload.

**GET /v1/user/{image}**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис minio GET /images/{image}.

### Ожидаемый результат

Результатом выполнения задачи должен быть docker compose файл, запустив который можно локально выполнить следующие команды с успешным результатом.
Предполагается, что для реализации API Gateway будет написан конфиг для NGinx или другого балансировщика нагрузки, который будет запущен как сервис через docker-compose и будет обеспечивать балансировку и проверку аутентификации входящих запросов.
Авторизация
curl -X POST -H 'Content-Type: application/json' -d '{"login":"bob", "password":"qwe123"}' http://localhost/token

**Загрузка файла**

curl -X POST -H 'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJib2IifQ.hiMVLmssoTsy1MqbmIoviDeFPvo-nCd92d4UFiN2O2I' -H 'Content-Type: octet/stream' --data-binary @yourfilename.jpg http://localhost/upload

**Получение файла**
curl -X GET http://localhost/images/4e6df220-295e-4231-82bc-45e4b1484430.jpg

## Ответ 3*

Для решения использовал дополнительные материалы к ДЗ.

Дополнительно искал статьи в интернете для выполнения задания, несколько из них:

1. [Готовый к работе сервер аутентификации с Nginx](https://metalblueberry.github.io/post/howto/2020-02-14_nginx_auth_server_with_go/)
2. [Защита веб-сайтов с помощью аутентификации по подзапросу NGINX](https://gock.net/blog/2020/nginx-subrequest-authentication-server)
3. [Модуль NGINX auth_request: Полное руководство](https://www.slingacademy.com/article/nginx-auth_request-module-complete-guide/)

Готовый конфиг NGINX [nginx.conf](./NGINX%20API%20Gateway/gateway/nginx.conf)

Добавил в [server.js](./NGINX%20API%20Gateway/uploader/src/server.js) маршрут GET /images/:filename.

Использовались следующий команды для теста:

``` bash
# Получить токен
$ curl -X POST -H 'Content-Type: application/json' -d '{"login":"bob", "password":"qwe123"}' http://192.168.1.114/v1/token
# Успено получен токен
eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJib2IifQ.hiMVLmssoTsy1MqbmIoviDeFPvo-nCd92d4UFiN2O2I

# Использовать полученный токен для загрузки картинки
curl -X POST -H 'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJib2IifQ.hiMVLmssoTsy1MqbmIoviDeFPvo-nCd92d4UFiN2O2I' -H 'Content-Type: octet/stream' --data-binary @1.jpg http://localhost/v1/upload
# Успешно загружен файл и получено имя файла из ответа JSON
{"filename":"6db4f1b0-6e84-4c1a-952d-5df3166b5f90.jpg"}

# Для проверки пробуем загрузить несуществующую картинку
$ curl -X GET http://192.168.1.114/images/no_file.jpg > no_file.jpg -H 'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ
zdWIiOiJib2IifQ.hiMVLmssoTsy1MqbmIoviDeFPvo-nCd92d4UFiN2O2I'
# >>>
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100    26  100    26    0     0   1236      0 --:--:-- --:--:-- --:--:--  1300

# Успешно загрузили существующую картинку
$ curl -X GET http://192.168.1.114/images/6db4f1b0-6e84-4c1a-952d-5df3166b5f90.jpg > 6db4f1b0-6e84-4c1a-952d-5df3166b5f90.jpg -H 'Auth
orization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJib2IifQ.hiMVLmssoTsy1MqbmIoviDeFPvo-nCd92d4UFiN2O2I'
# >>>
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100 11555    0 11555    0     0   378k      0 --:--:-- --:--:-- --:--:--  389k

```

Выполнение команд в терминале, рис.:

![](./img/20-02-03-01.png)

Логи docker compose, рис.:

![](./img/20-02-03-02.png)

---

#### [Дополнительные материалы: как запускать, как тестировать, как проверить](https://github.com/netology-code/devkub-homeworks/tree/main/11-microservices-02-principles)

---

## Как оформить ДЗ?

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

---
